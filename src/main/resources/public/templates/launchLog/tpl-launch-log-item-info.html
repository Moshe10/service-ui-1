<% var isDebug = (data.context === 'userdebug') %>
<div class="launch-log-item-info">
    <div class="item-info">
        <div data-js-item-info-issue class="launch-log-item-issue row">
            <div class="item-issue-container" data-js-step-issue></div>
            <div class="hide retries-container" data-js-retries-container>
                <span class="retries-label"><%= data.text.launches.retries %>:</span>
            </div>
            <% if (!isDebug) { %>
            <div class="button-container">
                <div class="rp-btn rp-btn-default rp-button-with-icon send-issue-data"
                    title="<%= data.text.launches.sendIssue %>" data-js-send-issue>
                    <i class="material-icons">call_made</i>
                    <span class="rp-btn-val hidden-sm hidden-xs"><%= data.sendDefectBtnText %></span>
                </div>


                <div class="rp-btn rp-btn-default rp-button-with-icon receive-issue-data"
                    title="<%= data.text.launches.receiveIssue %>" data-js-receive-issue>
                    <i class="material-icons">call_received</i>
                    <span class="rp-btn-val hidden-sm hidden-xs"><%= data.copyDefectBtnText %></span>
                </div>


                <!-- orginal -->

                <div class="rp-btn rp-btn-default rp-button-with-icon" title="<%= data.text.launches.postBug %>"
                    data-js-post-bug>
                    <i class="material-icons">bug_report</i>
                    <span class="rp-btn-val hidden-sm hidden-xs"><%= data.text.launches.postBug %></span>
                </div>

                <!-- orginal -->

                <!--moshe beeri -->

                <!-- <div class="rp-btn rp-btn-default rp-button-with-icon" title="<%= data.text.launches.postBug %>"
                    my-data-js-post-bug>
                    <i class="material-icons">bug_report</i>
                    <span class="rp-btn-val hidden-sm hidden-xs">my post issus</span>
                </div>
                <div> -->

                <!-- Button trigger modal -->
                <button type="button" class="rp-btn rp-btn-default rp-button-with-icon" data-toggle="modal"
                    data-target="#exampleModalCenter">
                    <i class="material-icons">bug_report</i>
                    <span class="rp-btn-val hidden-sm hidden-xs">Post to Trello</span>
                </button>

                <!-- Modal -->
                <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
                    aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLongTitle">Report to Trello</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form class="needs-validation" novalidate>
                                    <div class="form-row">
                                        <div class="col-md-5 mb-3">
                                            <label for="exampleFormControlSelect1">All boards</label>
                                            <select class="form-control" id="allBoardsSelect"
                                                onchange="selectBoard(this)"><option>SELECT</option></select>
                                        </div>
                                        <div class="col-md-5 mb-3">
                                            <label for="exampleFormControlSelect1">Lists</label>
                                            <select class="form-control" id="allListsSelect"
                                                onchange="selectList(this)">

                                            </select>
                                        </div>
                                    </div>
                                    <!-- hide -->
                                    <div style="display:none" id='data-trello'>
                                        <div class="form-row">
                                            <div class="col-md-10 mb-3">
                                                <label for="validationCustom02">BUG TITLE</label>
                                                <input type="text" class="form-control" id="cardTitle"
                                                    placeholder="Your title to the bug card..." name="cardTitle"
                                                    onchange="handleChange(this)">
                                            </div>
                                            <div class="col-md-10 mb-3">
                                                <label for="comment">Description :</label>
                                                <textarea class="form-control" rows="3" onchange="handleChange(this)"
                                                    name='comment1' id="comment1"></textarea>
                                            </div>
                                            <div class="col-md-10 mb-3">
                                                <label for="comment">how to reproduce :</label>
                                                <textarea class="form-control" rows="3" onchange="handleChange(this)"
                                                    name='comment2' id="comment2"></textarea>
                                            </div>
                                            <div class="col-md-10 mb-3">
                                                <label for="comment">expected result :</label>
                                                <textarea class="form-control" rows="3" onchange="handleChange(this)"
                                                    name='comment3' id="comment3"></textarea>
                                            </div>
                                            <div class="col-md-10 mb-3">
                                                <label for="comment">actually result :</label>
                                                <textarea class="form-control" rows="3" onchange="handleChange(this)"
                                                    name='comment4' id="comment4"></textarea>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="col-md-4 mb-3">
                                                <label for="exampleFormControlSelect1">Agent</label><br />
                                                <input class="form-control" id="AGENT" name="AGENT" type="text"
                                                    onchange="handleChange(this)" placeholder="Add agent...">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="exampleFormControlSelect1">Priority</label>
                                                <select class="form-control" name="PRIORITY" id="PRIORITY"
                                                    onchange="handleChange(this)">
                                                    <option>SELECT</option>
                                                    <option>H</option>
                                                    <option>M</option>
                                                    <option>L</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="exampleFormControlSelect1">App version</label><br />
                                                <input class="form-control" type="text" name="APP_VERSION"
                                                    id="APP_VERSION" onchange="handleChange(this)"
                                                    placeholder="Add App version...">
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="col-md-4 mb-3">
                                                <label for="exampleFormControlSelect1">bug tiket</label><br />
                                                <input class="form-control" type="text" id="BUG_TICKET"
                                                    name="BUG_TICKET" onchange="handleChange(this)"
                                                    placeholder="Add Bug ticket...">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="exampleFormControlSelect1">date</label><br />
                                                <input type="date" onchange="handleChange(this)" id="DATE" name="DATE">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <br />
                                                <input type="checkbox" class="form-check-input" id="ABLE_TO_REPRODUCE"
                                                    name="ABLE_TO_REPRODUCE" onclick="handleChange(this)">
                                                <label class="form-check-label" for="exampleCheck1">Able to
                                                    reproduce</label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- hide -->
                                </form>
                            </div>
                            <br />
                            <div class="modal-footer">
                                <button style="display:none" class="btn btn-success" id="myInfo" disabled></button>
                                <button type="button" class="btn btn-secondary" id="close1"
                                    data-dismiss="modal">Close</button>
                                <button type="button" onclick="sendToTrello()" id="sendTotrello"
                                    class="btn btn-primary">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- orginal -->
                <div class="rp-btn rp-btn-default rp-button-with-icon" title="<%= data.text.launches.linkIssue %>"
                    data-js-load-bug>
                    <i class="material-icons">link</i>
                    <span class="rp-btn-val hidden-sm hidden-xs"><%= data.text.launches.linkIssue %></span>
                </div>
                <!-- orginal -->

            </div>

            <script>

                var trelloInfo = {
                    key: 'f82341477d9945fa09f2babfd04fd90d',
                    token: '6d0c45de4084717470f61741e57c263e6eb08ddcadf9421a4c9e2dac99168feb',
                    idOrganization: '5cad87eb8d26e64fcc5f81ed',
                };

                var boards = [];
                let currentBoardId = null;
                let currentIdList;
                var currentCardId;
                var customfiledIdArr = [];
                var state = { ABLE_TO_REPRODUCE: false };

                getAllBoardsFromTrello();

                returnOption(this.boards, "allBoardsSelect");

                function filterBoards(arr) {

                    let myArr = [];

                    arr.map(board => {
                        if(board.name.endsWith("_Bugs")) {
                            myArr.push(board);
                        }
                    });
                    return myArr;
                }

                function getAllBoardsFromTrello() {

                    var getAllBoards = `https://api.trello.com/1/organizations/` + this.trelloInfo.idOrganization + `/boards?filter=open&fields=all&key=` +
                        this.trelloInfo.key + `&token=` + this.trelloInfo.token;

                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            let parsed_data = JSON.parse(this.responseText);
                            console.log('parsed_data, ', parsed_data);
                            
                            boards = filterBoards(parsed_data);
                            console.log('boards after filter, ', boards);
                            
                        }
                    };
                    xhttp.open("GET", getAllBoards, false);
                    xhttp.send();
                }


                function returnOption(arr, elementID) {
                    let MySelect = document.getElementById(elementID);

                    arr.map((item, index) => {
                        let o = document.createElement("OPTION");
                        o.setAttribute("value", "" + item.id);
                        o.appendChild(document.createTextNode(item.name));
                        MySelect.appendChild(o);
                    });
                }


                function selectBoard(e) {
                    let myBoardId = e.value;
                    currentBoardId = myBoardId;
                    let cards = this.returnAllLists(myBoardId);
                    this.returnCardOption(cards);
                }


                function returnAllLists(id) {
                    let allCards = [];

                    let getAllCards = 'https://api.trello.com/1/boards/' + id + '/lists?cards=none&card_fields=all&filter=open&key=' +
                        this.trelloInfo.key + '&token=' + this.trelloInfo.token;

                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            let parsed_data = JSON.parse(this.responseText);
                            allCards = parsed_data
                        }
                    };
                    xhttp.open("GET", getAllCards, false);
                    xhttp.send();
                    return allCards;
                }


                function returnCardOption(arr) {
                    let MySelect = document.getElementById("allListsSelect");
                    MySelect.innerHTML = '';
                    let firstOpt = document.createElement("OPTION");
                    firstOpt.setAttribute("value", "11");
                    firstOpt.appendChild(document.createTextNode('SELECT'));
                    MySelect.appendChild(firstOpt)

                    arr.map((item, index) => {
                        let o = document.createElement("OPTION");
                        o.setAttribute("value", "" + item.id);
                        o.appendChild(document.createTextNode(item.name));
                        MySelect.appendChild(o);
                    });
                }

                function selectList(e) {
                    let listId = e.value;
                    this.currentIdList = listId;
                    document.getElementById('data-trello').style.display = 'block';

                }

                function handleChange(e) {
                    if (e.name === 'ABLE_TO_REPRODUCE') {
                        e.checked ? this.state[e.name] = 'true' : this.state[e.name] = 'false';
                    }
                    else {
                        this.state[e.name] = e.value;
                    }
                }

                function get_cf_idFromTrello() {
                    let data = null;
                    let trelloApi = 'https://api.trello.com/1/boards/' + currentBoardId + '/customFields?key=' + this.trelloInfo.key + '&token=' + this.trelloInfo.token;
                    let xhr = new XMLHttpRequest();
                    xhr.addEventListener("readystatechange", function () {
                        if (this.readyState === this.DONE) {
                            let dataFromTrello = JSON.parse(this.response);
                            customfiledIdArr = dataFromTrello;
                        }
                    });
                    xhr.open("GET", trelloApi, false);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(data);
                }


                function selectFilter(obj, selected) {
                    let s;
                    obj.options.map(opt => {
                        if (opt.value.text === selected) {
                            s = opt.id;
                        }
                    })
                    return s;
                }

                function myFilter(obj) {
                    let name = obj.name.replace(/ /g, "_");
                    let value;
                    switch (obj.name) {
                        case 'ABLE TO REPRODUCE':
                            return { "value": { "checked": state[name] } };
                        case 'DATE':
                            return { "value": { "date": state[name] } };
                        case 'PRIORITY':
                            let optId = selectFilter(obj, state[name]);
                            return { "idValue": optId };
                        case 'AGENT':
                            return { "value": { "text": state[name] } };
                        case 'APP VERSION':
                            return { "value": { "text": state[name] } };
                        case 'BUG TICKET':
                            return { "value": { "text": state[name] } };
                    }
                }

                function sendCF_ToTrello() {
                    customfiledIdArr.map((obj, i) => {

                        let data = myFilter(obj);

                        let trelloAPI = 'https://api.trello.com/1/card/' + currentCardId + '/customField/' + obj.id + '/item?key=' + this.trelloInfo.key + '&token=' + this.trelloInfo.token;
                        let xhr = new XMLHttpRequest();
                        xhr.addEventListener("readystatechange", function () {
                            if (this.readyState === this.DONE) {
                                console.log(this.responseText);
                                document.getElementById('myInfo').style.display = 'block';
                                document.getElementById('myInfo').innerHTML = 'Message received';
                            }
                        });
                        xhr.open("PUT", trelloAPI, false);
                        xhr.setRequestHeader('Content-Type', 'application/json');
                        xhr.send(JSON.stringify(data));
                    });
                }

                function checksIfAllFieldsAreFilled() {
                    const arr = ['comment1', 'comment2', 'comment3', 'comment4', 'ABLE_TO_REPRODUCE', 'DATE', 'PRIORITY', 'AGENT', 'APP_VERSION', 'BUG_TICKET', 'cardTitle'];
                
                    myCheckArr = [];
                    arr.map(elm => {
                        if (state[elm] === undefined || state[elm] === ""  || state[elm] === "SELECT") {
                            myCheckArr.push(elm);
                        }
                    });
                    if (myCheckArr.length > 0) {
                        return false;
                    }
                    else return true
                }


                function sendToTrello() {
                    let check = checksIfAllFieldsAreFilled();
                    if (check) {
                        var data = null;
                        let desc = 'Description : ' + this.state.comment1 + '%0A how to reproduce : ' + this.state.comment2 + '%0A expected result: ' + this.state.comment3 + '%0A actually result: ' + this.state.comment4;
                        let trelloUrl = "https://api.trello.com/1/cards?name=" + this.state.cardTitle + "&desc= " + desc + "&idList=" + this.currentIdList + "&key=" +
                            this.trelloInfo.key + '&token=' + this.trelloInfo.token;
    
                        var xhr = new XMLHttpRequest();
                        xhr.addEventListener("readystatechange", function () {
                            if (this.readyState === this.DONE) {
                                let cardDetails = JSON.parse(this.response);
                                currentCardId = cardDetails.id;
                              
                            }
                        });
                        xhr.open("POST", trelloUrl, false);
                        xhr.send(data);
                        get_cf_idFromTrello();
                        sendCF_ToTrello();
                    }
                    else alert('Sorry, missing details on the form');
                }



            </script>
            <!--moshe beeri -->


            <% } %>
        </div>
    </div>
    <div data-js-tabs-container></div>
</div>
